<script setup lang="ts">
import { computed } from 'vue'
import { Head, Link } from '@inertiajs/vue3'
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout.vue'
import DatePickerShadcn from '@/Components/ui/DatePickerShadcn.vue'

import { ArrowLeft, Upload, FileText, X } from 'lucide-vue-next'
import type { RequisicionPagoPageProps } from './Pagar.types'
import { useRequisicionPago } from './useRequisicionPago'

declare const route: any

const props = defineProps<RequisicionPagoPageProps>()

const {
  req,
  pagos,
  pendiente,
  money,
  fmtLong,

  form,
  submitting,

  fileKey,
  dragActive,
  pickedName,
  hasPicked,
  clearFile,
  onPickFile,
  onDropFile,
  onDragEnter,
  onDragOver,
  onDragLeave,

  uploadPreview,

  onMontoInput,
  canSubmit,
  submit,
} = useRequisicionPago(props)

const tot = computed(() => props.totales)

const inputBase =
  'w-full rounded-2xl border border-slate-200/70 bg-white/90 px-4 py-3 text-sm font-semibold text-slate-900 ' +
  'placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/30 focus:border-emerald-500/40 ' +
  'dark:border-white/10 dark:bg-neutral-950/40 dark:text-neutral-100 dark:placeholder:text-neutral-500'
</script>

<template>
  <Head title="Pagar requisición" />

  <AuthenticatedLayout>
    <template #header>
      <div class="flex items-center gap-3 min-w-0">
        <Link
          :href="route('requisiciones.index')"
          class="inline-flex items-center justify-center h-10 w-10 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50
                 dark:border-white/10 dark:bg-neutral-900 dark:hover:bg-white/10 transition active:scale-[0.98]"
          title="Volver"
        >
          <ArrowLeft class="h-5 w-5" />
        </Link>

        <div class="min-w-0">
          <div class="text-xl font-black text-slate-900 dark:text-neutral-100 truncate">Pagar</div>
        </div>
      </div>
    </template>

    <div class="w-full min-w-0 flex-1 overflow-x-hidden">
      <div class="mx-auto w-full min-w-0 max-w-[1900px] px-3 sm:px-6 lg:px-8 py-4 sm:py-6 space-y-4">

        <!-- Resumen -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="rounded-3xl border border-slate-200/70 dark:border-white/10 bg-white/85 dark:bg-neutral-900/70 backdrop-blur shadow-sm p-5">
            <div class="text-xs font-black text-slate-500 dark:text-neutral-300">DATOS DE LA REQUISICIÓN</div>

            <div class="mt-3 space-y-2 text-sm">
              <div>
                <span class="font-black text-slate-700 dark:text-neutral-200">Solicitante:</span>
                <span class="text-slate-900 dark:text-neutral-100"> {{ req?.solicitante_nombre }}</span>
              </div>

              <div>
                <span class="font-black text-slate-700 dark:text-neutral-200">Concepto:</span>
                <span class="text-slate-900 dark:text-neutral-100"> {{ req?.concepto || '—' }}</span>
              </div>

              <div>
                <span class="font-black text-slate-700 dark:text-neutral-200">Cantidad a pagar:</span>
                <span class="text-slate-900 dark:text-neutral-100"> {{ money(req?.monto_total) }}</span>
              </div>

              <div class="pt-2 grid grid-cols-2 gap-3">
                <div class="rounded-2xl border border-slate-200/60 dark:border-white/10 bg-slate-50/70 dark:bg-neutral-950/40 p-3">
                  <div class="text-[11px] font-black text-slate-500 dark:text-neutral-400">Pagado</div>
                  <div class="text-sm font-black text-slate-900 dark:text-neutral-100">{{ money(tot.pagado) }}</div>
                </div>

                <div class="rounded-2xl border border-slate-200/60 dark:border-white/10 bg-slate-50/70 dark:bg-neutral-950/40 p-3">
                  <div class="text-[11px] font-black text-slate-500 dark:text-neutral-400">Pendiente</div>
                  <div class="text-sm font-black text-slate-900 dark:text-neutral-100">{{ money(tot.pendiente) }}</div>
                </div>
              </div>
            </div>
          </div>

          <div class="rounded-3xl border border-slate-200/70 dark:border-white/10 bg-white/85 dark:bg-neutral-900/70 backdrop-blur shadow-sm p-5">
            <div class="text-xs font-black text-slate-500 dark:text-neutral-300">DATOS DEL BENEFICIARIO</div>

            <div class="mt-3 space-y-2 text-sm">
              <div>
                <span class="font-black text-slate-700 dark:text-neutral-200">Beneficiario:</span>
                <span class="text-slate-900 dark:text-neutral-100"> {{ req?.beneficiario?.nombre || '—' }}</span>
              </div>
              <div>
                <span class="font-black text-slate-700 dark:text-neutral-200">RFC:</span>
                <span class="text-slate-900 dark:text-neutral-100"> {{ req?.beneficiario?.rfc || '—' }}</span>
              </div>
              <div>
                <span class="font-black text-slate-700 dark:text-neutral-200">Clabe:</span>
                <span class="text-slate-900 dark:text-neutral-100"> {{ req?.beneficiario?.clabe || '—' }}</span>
              </div>
              <div>
                <span class="font-black text-slate-700 dark:text-neutral-200">Banco:</span>
                <span class="text-slate-900 dark:text-neutral-100"> {{ req?.beneficiario?.banco || '—' }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Relación de pagos -->
        <div class="rounded-3xl border border-slate-200/70 dark:border-white/10 bg-white/85 dark:bg-neutral-900/70 backdrop-blur shadow-sm overflow-hidden">
          <div class="px-5 py-4 border-b border-slate-200/70 dark:border-white/10">
            <div class="text-lg font-black text-slate-900 dark:text-neutral-100">Relación de pagos</div>
            <div class="text-sm text-slate-500 dark:text-neutral-300">
              Adjunta comprobante por movimiento. Sin archivo no hay pago.
            </div>
          </div>

          <!-- TABLE (lg+) -->
          <div class="hidden lg:block">
            <table class="w-full">
              <thead class="bg-slate-50/80 dark:bg-neutral-950/40">
                <tr class="text-left text-[12px] font-black text-slate-600 dark:text-neutral-300">
                  <th class="px-5 py-3 w-[90px]">Id</th>
                  <th class="px-5 py-3">Fecha</th>
                  <th class="px-5 py-3">Tipo</th>
                  <th class="px-5 py-3">Monto</th>
                  <th class="px-5 py-3">Archivo</th>
                </tr>
              </thead>

              <tbody>
                <tr
                  v-for="p in pagos"
                  :key="p.id"
                  class="border-t border-slate-200/70 dark:border-white/10 hover:bg-slate-50/70 dark:hover:bg-white/5 transition"
                >
                  <td class="px-5 py-3 text-sm font-black text-slate-900 dark:text-neutral-100">{{ p.id }}</td>
                  <td class="px-5 py-3 text-sm text-slate-800 dark:text-neutral-100">{{ fmtLong(p.fecha_pago) }}</td>
                  <td class="px-5 py-3 text-sm text-slate-800 dark:text-neutral-100">{{ (p.tipo_pago || '').toLowerCase() }}</td>
                  <td class="px-5 py-3 text-sm font-black text-slate-900 dark:text-neutral-100">{{ money(p.monto) }}</td>
                  <td class="px-5 py-3 text-sm">
                    <a
                      v-if="p.archivo?.url"
                      :href="p.archivo.url"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="inline-flex items-center gap-2 font-black text-emerald-700 hover:text-emerald-800 dark:text-emerald-300 dark:hover:text-emerald-200"
                    >
                      <FileText class="h-4 w-4" />
                      {{ p.archivo.label }}
                    </a>
                    <span v-else class="text-slate-500 dark:text-neutral-400">—</span>
                  </td>
                </tr>

                <tr v-if="pagos.length === 0">
                  <td colspan="5" class="px-5 py-8 text-center text-sm text-slate-500 dark:text-neutral-400">
                    Aún no hay pagos registrados.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- CARDS (mobile/tablet) -->
          <div class="lg:hidden divide-y divide-slate-200/70 dark:divide-white/10">
            <div v-if="pagos.length === 0" class="px-5 py-8 text-center text-sm text-slate-500 dark:text-neutral-400">
              Aún no hay pagos registrados.
            </div>

            <div v-for="p in pagos" :key="p.id" class="px-5 py-4">
              <div class="flex items-center justify-between gap-3">
                <div class="text-sm font-black text-slate-900 dark:text-neutral-100">#{{ p.id }}</div>
                <div class="text-xs text-slate-500 dark:text-neutral-400">{{ fmtLong(p.fecha_pago) }}</div>
              </div>

              <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
                <div class="rounded-2xl border border-slate-200/60 dark:border-white/10 bg-slate-50/70 dark:bg-neutral-950/40 p-3">
                  <div class="text-[11px] font-black text-slate-500 dark:text-neutral-400">Tipo</div>
                  <div class="font-semibold text-slate-900 dark:text-neutral-100">{{ (p.tipo_pago || '').toLowerCase() }}</div>
                </div>

                <div class="rounded-2xl border border-slate-200/60 dark:border-white/10 bg-slate-50/70 dark:bg-neutral-950/40 p-3">
                  <div class="text-[11px] font-black text-slate-500 dark:text-neutral-400">Monto</div>
                  <div class="font-black text-slate-900 dark:text-neutral-100">{{ money(p.monto) }}</div>
                </div>
              </div>

              <div class="mt-3">
                <a
                  v-if="p.archivo?.url"
                  :href="p.archivo.url"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-2 text-sm font-black text-emerald-700 hover:text-emerald-800 dark:text-emerald-300 dark:hover:text-emerald-200"
                >
                  <FileText class="h-4 w-4" />
                  {{ p.archivo.label }}
                </a>
                <div v-else class="text-sm text-slate-500 dark:text-neutral-400">Sin archivo</div>
              </div>
            </div>
          </div>

          <!-- Form carga -->
          <div class="p-5 border-t border-slate-200/70 dark:border-white/10">
            <div class="space-y-4">

              <!-- Archivo + preview antes de subir -->
              <div class="min-w-0">
                <div class="flex items-end justify-between gap-3">
                  <label class="block text-xs font-black text-slate-600 dark:text-neutral-300">Comprobante de pago</label>
                  <div class="text-[12px] font-black text-slate-500 dark:text-neutral-300">
                    Pendiente:
                    <span class="text-slate-900 dark:text-neutral-100">{{ money(pendiente) }}</span>
                  </div>
                </div>

                <div
                  class="mt-1 rounded-3xl border bg-white/80 dark:bg-neutral-950/40 p-3 select-none
                         transition duration-200 hover:shadow-sm hover:-translate-y-[1px] min-w-0"
                  :class="dragActive
                    ? 'border-emerald-400/60 ring-2 ring-emerald-500/20 dark:border-emerald-400/40'
                    : 'border-slate-200/70 dark:border-white/10'"
                  @dragenter="onDragEnter"
                  @dragover="onDragOver"
                  @dragleave="onDragLeave"
                  @drop="onDropFile"
                >
                  <div class="flex items-center gap-3 min-w-0">
                    <input
                      :key="fileKey"
                      id="pago-file"
                      type="file"
                      class="sr-only"
                      accept=".pdf,.png,.jpg,.jpeg,.webp"
                      @change="onPickFile"
                    />

                    <label
                      for="pago-file"
                      class="inline-flex items-center justify-center gap-2 rounded-2xl px-6 py-3 text-sm font-black
                             bg-emerald-600 text-white hover:bg-emerald-700 hover:shadow-md
                             transition active:scale-[0.98] cursor-pointer shrink-0"
                    >
                      <Upload class="h-4 w-4" />
                      Seleccionar archivo
                    </label>

                    <div class="min-w-0 flex-1">
                      <div
                        class="text-sm font-black truncate"
                        :class="hasPicked ? 'text-slate-900 dark:text-neutral-100' : 'text-slate-500 dark:text-neutral-400'"
                        :title="pickedName"
                      >
                        {{ pickedName }}
                      </div>
                      <div class="text-[12px] text-slate-500 dark:text-neutral-400">
                        {{ dragActive ? 'Suelta aquí para adjuntar.' : (hasPicked ? 'Listo para subir.' : 'Arrastra y suelta o selecciona un archivo.') }}
                        (PDF/PNG/JPG/WebP, máx. 10MB)
                      </div>
                    </div>

                    <button
                      v-if="hasPicked"
                      type="button"
                      class="inline-flex items-center justify-center h-10 w-10 rounded-2xl border border-slate-200 bg-white
                             hover:bg-slate-50 hover:shadow-sm dark:border-white/10 dark:bg-white/10 dark:hover:bg-white/15
                             transition active:scale-[0.98] shrink-0"
                      title="Quitar archivo"
                      @click="clearFile"
                    >
                      <X class="h-4 w-4 text-slate-700 dark:text-neutral-100" />
                    </button>
                  </div>
                </div>

                <div v-if="form.errors.archivo" class="mt-1 text-xs font-bold text-rose-600">
                  {{ form.errors.archivo }}
                </div>

                <!-- Preview ANTES de subir (igual que Comprobar) -->
                <div
                  v-if="uploadPreview"
                  class="mt-3 rounded-3xl border border-slate-200/70 dark:border-white/10 bg-white/85 dark:bg-neutral-900/60 overflow-hidden"
                >
                  <div class="px-4 py-3 border-b border-slate-200/70 dark:border-white/10">
                    <div class="text-xs font-black text-slate-500 dark:text-neutral-300">PREVISUALIZACIÓN ANTES DE SUBIR</div>
                    <div class="text-sm font-black text-slate-900 dark:text-neutral-100 truncate" :title="uploadPreview.name">
                      {{ uploadPreview.name }}
                    </div>
                  </div>

                  <div class="p-3">
                    <div class="rounded-3xl border border-slate-200/60 dark:border-white/10 bg-slate-50/60 dark:bg-white/5 overflow-hidden">
                      <div class="h-[38vh] sm:h-[42vh] max-h-[420px]">
                        <iframe
                          v-if="uploadPreview.kind === 'pdf'"
                          :src="uploadPreview.url"
                          class="w-full h-full block"
                          style="border:0;"
                          title="Preview antes de subir"
                        />
                        <div v-else-if="uploadPreview.kind === 'image'" class="w-full h-full flex items-center justify-center">
                          <img :src="uploadPreview.url" alt="Preview" class="w-full h-full object-contain" />
                        </div>
                        <div v-else class="w-full h-full flex items-center justify-center p-6 text-center">
                          <div class="text-sm text-slate-600 dark:text-neutral-300">
                            Este archivo no tiene preview aquí. Igual se puede subir.
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="mt-2 text-[12px] text-slate-500 dark:text-neutral-400">
                      Se subirá exactamente este archivo.
                    </div>
                  </div>
                </div>
              </div>

              <!-- Campos (como tu layout viejo): fecha, monto, tipo -->
              <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 items-end min-w-0">
                <div class="lg:col-span-3 min-w-0">
                  <label class="block text-xs font-black text-slate-600 dark:text-neutral-300">Fecha de pago</label>
                  <DatePickerShadcn v-model="form.fecha_pago" placeholder="Selecciona fecha" />
                  <div v-if="form.errors.fecha_pago" class="mt-1 text-xs font-bold text-rose-600">{{ form.errors.fecha_pago }}</div>
                </div>

                <div class="lg:col-span-4 min-w-0">
                  <div class="flex items-end justify-between gap-3">
                    <label class="block text-xs font-black text-slate-600 dark:text-neutral-300">Monto pagado</label>
                    <div class="text-[11px] font-black text-slate-500 dark:text-neutral-300">
                      Máx: {{ money(pendiente) }}
                    </div>
                  </div>

                  <input
                    v-model="form.monto"
                    type="number"
                    inputmode="decimal"
                    step="0.01"
                    min="0"
                    :max="pendiente"
                    :class="inputBase"
                    class="mt-1"
                    placeholder="0.00"
                    @input="onMontoInput"
                  />

                  <div v-if="form.errors.monto" class="mt-1 text-xs font-bold text-rose-600">{{ form.errors.monto }}</div>

                  <div class="mt-1 text-[12px] text-slate-500 dark:text-neutral-400">
                    Pendiente: <span class="font-black">{{ money(pendiente) }}</span>
                  </div>
                </div>

                <div class="lg:col-span-5 min-w-0">
                  <label class="block text-xs font-black text-slate-600 dark:text-neutral-300">Tipo de pago</label>
                  <select v-model="form.tipo_pago" :class="inputBase" class="mt-1">
                    <option value="" disabled>Seleccione...</option>
                    <option v-for="t in props.tipoPagoOptions" :key="t.id" :value="t.id">{{ t.nombre }}</option>
                  </select>
                  <div v-if="form.errors.tipo_pago" class="mt-1 text-xs font-bold text-rose-600">{{ form.errors.tipo_pago }}</div>
                </div>

                <div class="lg:col-span-12 min-w-0">
                  <button
                    type="button"
                    :disabled="!canSubmit || submitting"
                    @click="submit"
                    class="w-full inline-flex items-center justify-center gap-2 rounded-2xl px-4 py-3 text-sm font-black
                           bg-slate-900 text-white hover:bg-slate-950 dark:bg-white dark:text-slate-900 dark:hover:bg-neutral-200
                           transition active:scale-[0.99] disabled:opacity-60 disabled:cursor-not-allowed"
                  >
                    <Upload class="h-4 w-4" />
                    Registrar pago
                  </button>
                </div>
              </div>

            </div>
          </div>
        </div>

      </div>
    </div>
  </AuthenticatedLayout>
</template>
